<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ESG Greenwashing Multi-Agent Demo</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen">
  <div class="max-w-6xl mx-auto py-8 px-4">
    <!-- Header -->
    <header class="mb-6">
      <h1 class="text-2xl font-bold text-slate-800">
        ESG「三角交叉比對」Multi-Agent Demo
      </h1>
      <p class="text-sm text-slate-600 mt-1">
        在下方輸入 <span class="font-semibold">公司名稱</span> 與
        <span class="font-semibold">查詢問題</span>，系統會同時呼叫 Agent A（承諾分析）、Agent B(TSJ資料比對)、
        Agent C（外部負面新聞），並由 Agent D 做綜合判讀。
      </p>
    </header>

    <!-- Form Card -->
    <section class="bg-white rounded-xl shadow p-5 mb-6">
      <form id="query-form" class="space-y-4">
        <div class="grid gap-4 md:grid-cols-2">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              公司名稱（Company）
            </label>
            <input
              id="input-company"
              type="text"
              placeholder="例如：台灣中油、台塑、遠東新…"
              list="companies-datalist"
              autocomplete="off"
              class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
            />
            <datalist id="companies-datalist"></datalist>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              查詢問題（Query）
            </label>
            <input
              id="input-query"
              type="text"
              placeholder="例如：請抽取該公司在淨零、減碳、環境罰款方面的承諾"
              class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
            />
          </div>
        </div>

        <div class="flex items-center gap-3">
          <button
            type="submit"
            class="inline-flex items-center px-4 py-2 rounded-lg bg-emerald-600 text-white text-sm font-medium hover:bg-emerald-700 disabled:opacity-60 disabled:cursor-not-allowed"
            id="submit-btn"
          >
            <span id="submit-btn-text">送出查詢（呼叫 Agents）</span>
            <svg
              id="loading-icon"
              class="ml-2 h-4 w-4 animate-spin hidden"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 100 16v-4l-3 3 3 3v-4a8 8 0 01-8-8z"
              ></path>
            </svg>
          </button>

          <p id="status-text" class="text-xs text-slate-500"></p>
        </div>
      </form>
    </section>

    <!-- Results Layout -->
    <section class="grid gap-4 lg:grid-cols-2">
      <!-- Agent A -->
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold text-slate-800 flex items-center justify-between">
          Agent A：承諾分析（Commitment Claims）
          <span
            id="agent-a-company"
            class="text-xs text-emerald-700 bg-emerald-50 border border-emerald-200 px-2 py-0.5 rounded-full"
          ></span>
        </h2>
        <p class="text-xs text-slate-500 mt-1">
          來源：企業永續報告書＋向量資料庫檢索結果，LLM 抽取承諾、目標與策略。
        </p>
        <div
          id="agent-a-empty"
          class="text-xs text-slate-400 italic mt-3"
        >
          尚未查詢，請先在上方輸入條件並送出。
        </div>
        <div
          id="agent-a-list"
          class="mt-3 space-y-3 max-h-[480px] overflow-auto hidden"
        ></div>
      </div>

      <!-- Agent C -->
      <div class="space-y-4">
        <!-- Agent C Events -->
        <div class="bg-white rounded-xl shadow p-4">
          <h2 class="text-lg font-semibold text-slate-800">
            Agent B：TEJ資料比對
          </h2>
          <p class="text-xs text-slate-500 mt-1">
            來源：TEJ.PRO資料集
          </p>
          <div
            id="agent-c-events-empty"
            class="text-xs text-slate-400 italic mt-3"
          >
            目前尚未有事件（或事件抽取尚未實作）。
          </div>
          <div
            id="agent-c-events"
            class="mt-3 space-y-3 max-h-48 overflow-auto hidden"
          ></div>
        </div>

        <!-- Agent C Candidates -->
        <div class="bg-white rounded-xl shadow p-4">
          <h2 class="text-sm font-semibold text-slate-800">
            Agent C：新聞候選列表（RSS Candidates）
          </h2>
          <p class="text-xs text-slate-500 mt-1">
            這裡顯示爬回來的新聞條目，可作為下一步 LLM 事件萃取的輸入來源。
          </p>
          <div
            id="agent-c-candidates-empty"
            class="text-xs text-slate-400 italic mt-3"
          >
            尚未查詢或尚未取得新聞資料。
          </div>
          <div
            id="agent-c-candidates"
            class="mt-3 space-y-3 max-h-64 overflow-auto hidden"
          ></div>
        </div>
      </div>
    </section>

    <!-- Agent D：綜合判讀 -->
    <section class="mt-6">
      <div class="bg-white shadow-md rounded-2xl p-6 border border-slate-200">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-semibold text-slate-800">
            Agent D：綜合判讀與漂綠風險評估（Greenwashing Assessment）
          </h2>
          <span class="inline-flex items-center text-xs px-2 py-1 rounded-full bg-indigo-50 text-indigo-700 border border-indigo-100">
            最終給使用者看的說明
          </span>
        </div>
        <p class="text-xs text-slate-500 mb-3">
          Agent D 會整合 Agent A（承諾）與 Agent C（外部事件），用自然語言說明是否存在「說一套、做一套」或資訊落差的可能性。
        </p>
        <div
          id="agent-d-content"
          class="text-sm leading-relaxed text-slate-800 whitespace-pre-wrap bg-slate-50 border border-slate-200 rounded-xl p-4 min-h-[120px]"
        >
          尚未查詢，請先在上方輸入公司與問題後送出。
        </div>
      </div>
    </section>
  </div>

  <script>
    const form = document.getElementById("query-form");
    const inputCompany = document.getElementById("input-company");
    const inputQuery = document.getElementById("input-query");
    const submitBtn = document.getElementById("submit-btn");
    const submitBtnText = document.getElementById("submit-btn-text");
    const loadingIcon = document.getElementById("loading-icon");
    const statusText = document.getElementById("status-text");

    const agentACompany = document.getElementById("agent-a-company");
    const agentAEmpty = document.getElementById("agent-a-empty");
    const agentAList = document.getElementById("agent-a-list");

    const agentCEventsEmpty = document.getElementById("agent-c-events-empty");
    const agentCEvents = document.getElementById("agent-c-events");
    const agentCCandidatesEmpty = document.getElementById("agent-c-candidates-empty");
    const agentCCandidates = document.getElementById("agent-c-candidates");

    // ⬅︎ 新增：Agent D 顯示區
    const agentDContent = document.getElementById("agent-d-content");

    function setLoading(isLoading, message = "") {
      if (isLoading) {
        submitBtn.disabled = true;
        submitBtnText.textContent = "處理中…";
        loadingIcon.classList.remove("hidden");
        statusText.textContent = message || "Agents 執行中，請稍候…";
      } else {
        submitBtn.disabled = false;
        submitBtnText.textContent = "送出查詢（呼叫 Agents）";
        loadingIcon.classList.add("hidden");
        statusText.textContent = message || "";
      }
    }

    // 載入後端 companies（供選單建議使用）
    async function loadCompanies() {
      try {
        const res = await fetch('/companies');
        if (!res.ok) return;
        const data = await res.json();
        const dl = document.getElementById('companies-datalist');
        dl.innerHTML = '';
        data.forEach(c => {
          const opt = document.createElement('option');
          // 使用 value 作為 canonical（前端選到的就是要回傳的字串）
          opt.value = c.value || c.label || '';
          dl.appendChild(opt);
        });
      } catch (e) {
        console.warn('無法載入 companies:', e);
      }
    }

    // 頁面載入時填入 companies
    loadCompanies();

    function clearResults() {
      agentACompany.textContent = "";
      agentAEmpty.classList.remove("hidden");
      agentAList.classList.add("hidden");
      agentAList.innerHTML = "";

      agentCEventsEmpty.classList.remove("hidden");
      agentCEvents.classList.add("hidden");
      agentCEvents.innerHTML = "";

      agentCCandidatesEmpty.classList.remove("hidden");
      agentCCandidates.classList.add("hidden");
      agentCCandidates.innerHTML = "";

      // 重置 Agent D 區塊
      agentDContent.textContent = "尚未查詢，請先在上方輸入公司與問題後送出。";
    }

    function renderAgentA(agentA) {
      if (!agentA || !Array.isArray(agentA.claims) || agentA.claims.length === 0) {
        agentACompany.textContent = agentA && agentA.selected_company
          ? `選中公司：${agentA.selected_company}`
          : "";
        agentAEmpty.textContent = "沒有從報告中抽到承諾（可能是查詢不夠明確或資料不足）。";
        agentAEmpty.classList.remove("hidden");
        agentAList.classList.add("hidden");
        return;
      }

      agentACompany.textContent = `選中公司：${agentA.selected_company || "（未知）"}`;
      agentAEmpty.classList.add("hidden");
      agentAList.classList.remove("hidden");
      agentAList.innerHTML = "";

      agentA.claims.forEach((c, idx) => {
        const card = document.createElement("div");
        card.className =
          "border border-slate-200 rounded-lg p-3 text-xs bg-slate-50";

        const header = document.createElement("div");
        header.className = "flex justify-between items-center mb-1";

        const left = document.createElement("div");
        left.className = "font-semibold text-slate-800";
        const topic = c.topic || "general";
        const metric = (c.metric || "").toLowerCase();

        let headerText = `#${idx + 1} ${topic}`;
        if (metric && metric !== "unknown") {
          headerText += ` | ${metric}`;
        }
        left.textContent = headerText;
        const right = document.createElement("div");
        right.className = "flex items-center gap-2";

        const certainty = document.createElement("span");
        certainty.className =
          "px-2 py-0.5 rounded-full border text-[10px] uppercase";
        const cert = (c.certainty || "").toLowerCase();
        if (cert === "high") {
          certainty.classList.add("bg-emerald-50", "border-emerald-300", "text-emerald-700");
        } else if (cert === "medium") {
          certainty.classList.add("bg-amber-50", "border-amber-300", "text-amber-700");
        } else {
          certainty.classList.add("bg-slate-50", "border-slate-300", "text-slate-600");
        }
        certainty.textContent = `certainty: ${cert || "unknown"}`;

        right.appendChild(certainty);
        header.appendChild(left);
        header.appendChild(right);

        const text = document.createElement("p");
        text.className = "text-slate-700 whitespace-pre-line";
        text.textContent = c.claim_text || "";

        card.appendChild(header);
        card.appendChild(text);

        if (Array.isArray(c.source_chunks) && c.source_chunks.length > 0) {
          const srcTitle = document.createElement("p");
          srcTitle.className = "mt-2 text-[11px] font-semibold text-slate-600";
          srcTitle.textContent = "來源片段：";
          card.appendChild(srcTitle);

          c.source_chunks.forEach((sc) => {
            const line = document.createElement("div");
            line.className =
              "mt-1 text-[11px] text-slate-600 border-l-2 border-slate-300 pl-2";
            line.textContent = `[#${sc.meta_id ?? sc.idx}] p.${sc.page ?? "?"} | ${sc.chunk ?? ""}`;
            card.appendChild(line);
          });
        }

        agentAList.appendChild(card);
      });
    }

    function renderAgentC(agentC) {
      // events
      if (agentC && Array.isArray(agentC.events) && agentC.events.length > 0) {
        agentCEventsEmpty.classList.add("hidden");
        agentCEvents.classList.remove("hidden");
        agentCEvents.innerHTML = "";

        agentC.events.forEach((e, idx) => {
          const card = document.createElement("div");
          card.className =
            "border border-rose-100 bg-rose-50 rounded-lg p-2 text-[11px]";
          const title = document.createElement("div");
          title.className = "font-semibold text-rose-800";
          title.textContent = `#${idx + 1} ${e.title || "外部事件"}`;
          const meta = document.createElement("div");
          meta.className = "text-rose-700 mt-1";
          meta.textContent = e.summary || "";
          card.appendChild(title);
          card.appendChild(meta);
          agentCEvents.appendChild(card);
        });
      } else {
        agentCEventsEmpty.classList.remove("hidden");
        agentCEvents.classList.add("hidden");
        agentCEvents.innerHTML = "";
      }

      // candidates_used
      if (agentC && Array.isArray(agentC.candidates_used) && agentC.candidates_used.length > 0) {
        agentCCandidatesEmpty.classList.add("hidden");
        agentCCandidates.classList.remove("hidden");
        agentCCandidates.innerHTML = "";

        agentC.candidates_used.forEach((n, idx) => {
          const card = document.createElement("div");
          card.className =
            "border border-slate-200 rounded-lg p-2 text-[11px] bg-white";

          const title = document.createElement("a");
          title.className = "font-semibold text-slate-800 hover:underline";
          title.href = n.link || "#";
          title.target = "_blank";
          title.rel = "noreferrer";
          title.textContent = `${idx + 1}. ${n.title || "(無標題新聞)"}`;

          const meta = document.createElement("div");
          meta.className = "mt-1 text-slate-500";
          const date = n.published || n.event_date_guess || "";
          const score = typeof n.relevance_score === "number"
            ? n.relevance_score.toFixed(3)
            : "–";
          meta.textContent = `來源: ${n.source || "unknown"} | 查詢: ${
            n.query || ""
          } | score: ${score}`;

          card.appendChild(title);
          card.appendChild(meta);
          agentCCandidates.appendChild(card);
        });
      } else {
        agentCCandidatesEmpty.classList.remove("hidden");
        agentCCandidates.classList.add("hidden");
        agentCCandidates.innerHTML = "";
      }
    }

    // ⬅︎ 新增：Agent D 渲染函式
    function renderAgentD(text) {
      if (text && text.trim()) {
        agentDContent.textContent = text;
      } else {
        agentDContent.textContent = "目前沒有足夠資料讓 Agent D 做出明確判讀。";
      }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearResults();

      const company = inputCompany.value.trim();
      const query = inputQuery.value.trim();

      if (!query && !company) {
        statusText.textContent = "至少要輸入公司名稱或查詢問題其中一項。";
        return;
      }

      // 提前告知 Agent D 正在整合
      agentDContent.textContent = "Agent D 正在整合 Agent A 與 Agent C 的結果進行判讀中…";

      setLoading(true, "向後端 /run 發送請求…");

      try {
        const resp = await fetch("/run", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            company,
            query,
          }),
        });

        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(`HTTP ${resp.status}: ${text}`);
        }

        const data = await resp.json();

        // 預期後端回傳格式：
        // {
        //   agent_a: {...},
        //   agent_c: {...},
        //   agent_d_text: "最終文字判讀"
        // }
        renderAgentA(data.agent_a || {});
        renderAgentC(data.agent_c || {});
        renderAgentD(data.agent_d_text || "");

        setLoading(false, "完成。你可以在下方查看 Agents 的分析結果。");
      } catch (err) {
        console.error(err);
        setLoading(false, "發生錯誤，請查看 console 或後端 log。");
        agentDContent.textContent = "呼叫 /run 時發生錯誤，請稍後再試。";
        alert("呼叫 /run 發生錯誤：\n" + err.message);
      }
    });
  </script>
</body>
</html>
